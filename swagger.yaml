openapi: 3.0.0
info:
  title: Nexumed API
  version: 1.0.0
  description: |
    This API allows EMRs to send patient work order files to Nexumed for secure processing and device-specific routing.

    **Security**: All requests must be sent over HTTPS.

    ---
    **Endpoints Overview**:
    - `POST /api/healthone/new-account`: HealthOne provisioning endpoint (OAuth-protected) to create a practice + admin + users.
    - `POST /api/receive-file-key`: Advanced file upload where the practice **API key** is provided via HTTP header (`x-api-key`). Nexumed automatically determines the procedure type from the uploaded file.
    - `GET /api/emr/procedures`: Returns the list of configured procedures (ECG, BP, Spiro, etc.) for the **practice** associated with the provided API key.
    - `GET /emr/eid/{drsId}/patient-data-out`: Get the most recently staged eID patient XML for a doctor.
    - `GET /api/emr/results`: Returns all queued result files (e.g. required file formats, PDFs) for the practice’s configured EMR provider.

servers:
  - url: https://api.nexumed.eu
    description: Production server

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: x-api-key

    HealthOneOAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    ErrorResponse:
      type: object
      properties:
        message:
          type: string

    HealthOneIncomingUser:
      type: object
      required: [email, drsId]
      properties:
        email:
          type: string
          example: "dr.vangastel@nexumed.be"
        role:
          type: string
          example: "Doctor"
        drsId:
          type: string
          example: "12345678901"
        firstName:
          type: string
          example: "Andre"
        lastName:
          type: string
          example: "Van Gastel"

    HealthOnePractice:
      type: object
      required: [name]
      properties:
        name:
          type: string
          example: "Huisartsenpraktijk Scharlach"
        vat:
          type: string
          example: "BE0123456789"
        addressLine1:
          type: string
          example: "Kerkstraat 10"
        postalCode:
          type: string
          example: "2000"
        town:
          type: string
          example: "Antwerpen"
        countryCode:
          type: string
          example: "BE"
        phone:
          type: string
          example: "+32479172881"

    HealthOneProvisioningPayload:
      type: object
      required: [schemaVersion, practice, admin, users]
      properties:
        schemaVersion:
          type: string
          example: "1.0"
        practice:
          $ref: "#/components/schemas/HealthOnePractice"
        admin:
          $ref: "#/components/schemas/HealthOneIncomingUser"
        users:
          type: array
          items:
            $ref: "#/components/schemas/HealthOneIncomingUser"

    HealthOneProvisioningCreatedItem:
      type: object
      required: [email, drsId, userId, isAdmin]
      properties:
        email:
          type: string
        drsId:
          type: string
        userId:
          type: string
        isAdmin:
          type: boolean

    HealthOneProvisioningSkippedItem:
      type: object
      required: [email, drsId, reason]
      properties:
        email:
          type: string
        drsId:
          type: string
        reason:
          type: string

    HealthOneProvisioningResponse:
      type: object
      required: [ok, practice, createdCount, skippedCount, created, skipped]
      properties:
        ok:
          type: boolean
          example: true
        practice:
          type: object
          required: [name, practiceId]
          properties:
            name:
              type: string
            practiceId:
              type: string
        createdCount:
          type: integer
        skippedCount:
          type: integer
        created:
          type: array
          items:
            $ref: "#/components/schemas/HealthOneProvisioningCreatedItem"
        skipped:
          type: array
          items:
            $ref: "#/components/schemas/HealthOneProvisioningSkippedItem"

paths:
  /api/healthone/new-account:
    post:
      summary: HealthOne — Provision a new practice (admin + users)
      description: |
        Creates a new Nexumed practice context for HealthOne, including:
        - 1 admin user (source of truth for practice configuration)
        - 0..N additional users
        - A practiceId (generated if the practice does not already exist)
        - A practice API key (generated once and sent **only to the admin** via email)
        - Email provisioning (verification + temporary password) for all created users

        **Important notes**
        - The API key is **not** returned in the API response; it is sent to the admin via email.
        - The Admin can be anyone of staff, doctor, nurse or office manager.  Just a designated staff memeber to fill the role
        - If a user already exists (email or drsId), they are skipped.
        - `practiceId` is resolved as:
          - If an existing user already has the same practice name + practiceId, tht practiceId is reused.
          - Otherwise a new unique practiceId is generated.
      security:
        - HealthOneOAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/HealthOneProvisioningPayload"
            example:
              schemaVersion: "1.0"
              practice:
                name: "Huisartsenpraktijk Scharlach"
                vat: "BE0123456789"
                addressLine1: "Kerkstraat 10"
                postalCode: "2000"
                town: "Antwerpen"
                countryCode: "BE"
                phone: "+32479172881"
              admin:
                email: "admin@nexumed.be"
                role: "Admin"
                drsId: "12345678965"
                firstName: "Joel"
                lastName: "Scharlach"
              users:
                - email: "dr.vangastel@nexumed.be"
                  role: "Doctor"
                  drsId: "12345678901"
                  firstName: "Andre"
                  lastName: "Van Gastel"
                - email: "dr.schoofs@nexumed.be"
                  role: "Doctor"
                  drsId: "10987654321"
                  firstName: "Lies"
                  lastName: "Schoofs"
      responses:
        "201":
          description: Provisioning completed (some users may be skipped)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthOneProvisioningResponse"
              example:
                ok: true
                practice:
                  name: "Huisartsenpraktijk Scharlach"
                  practiceId: "1234567080226"
                createdCount: 2
                skippedCount: 1
                created:
                  - email: "admin@nexumed.be"
                    drsId: "HO-ADMIN-0001"
                    userId: "65f0c2a3d9b1c3a2d1e4f123"
                    isAdmin: true
                  - email: "dr.vangastel@nexumed.be"
                    drsId: "12345678901"
                    userId: "65f0c2a3d9b1c3a2d1e4f456"
                    isAdmin: false
                skipped:
                  - email: "dr.schoofs@nexumed.be"
                    drsId: "10987654321"
                    reason: "user already exists (email or drsId)"
        "400":
          description: Invalid request (missing required fields)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "admin.email and admin.drsId are required"
        "401":
          description: Unauthorized (missing/invalid OAuth token)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Unauthorized"
        "500":
          description: Internal server error (provisioning failed)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                message: "Failed to provision HealthOne practice."

  /api/receive-file-key:
    post:
      summary: Upload work order file (via API key)
      description: |
        Upload a patient work order file.

        **Authentication**:
        - HTTP header: `x-api-key: YOUR_API_KEY`

        Nexumed will:
        - Validate the API key and subscription.
        - Detect file format (GDT / XML / HL7 / Unknown).
        - Detect procedure from file content.
        - Attempt to route and convert the work order internally based on the practice configuration.

        This endpoint is intended as a fire-and-forget upload endpoint.
      security:
        - ApiKeyAuth: []

      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file]
              properties:
                file:
                  type: string
                  format: binary
                  description: The medical work order file (GDT, XML, HL7).

      responses:
        "200":
          description: File received and processed
          content:
            application/json:
              schema:
                type: object
                required: [message, drsId, emr, procedure, format]
                properties:
                  message:
                    type: string
                    example: Work order parsed
                  drsId:
                    type: string
                    example: "98765432112"
                  emr:
                    type: string
                    example: "EMR name"
                  procedure:
                    type: string
                    example: "Spiro"
                  format:
                    type: string
                    enum: [GDT, XML, HL7, Unknown]
                    example: "XML"
                  device:
                    nullable: true
                    description: Matching device configuration for this procedure (if found)
                    type: object
                    additionalProperties: true
                  converted:
                    nullable: true
                    description: Present when a conversion or queue action was performed; otherwise null
                    oneOf:
                      - type: "null"
                      - type: object
                        description: Conversion applied internally (file mode)
                        required: [mode, targetFormat]
                        properties:
                          mode:
                            type: string
                            enum: ["file"]
                            example: "file"
                          targetFormat:
                            type: string
                            example: "GDT"
                      - type: object
                        description: MIR work order queued internally
                        required: [mode, targetFormat, orderId]
                        properties:
                          mode:
                            type: string
                            enum: ["mirQueue"]
                            example: "mirQueue"
                          targetFormat:
                            type: string
                            enum: ["HL7"]
                            example: "HL7"
                          orderId:
                            type: string
                            example: "c1f8a7b8-5c29-4dd3-b8c0-7f5f4c2a21cd"

        "400":
          description: Bad request (missing file)
        "401":
          description: Unauthorized (invalid API key)
        "403":
          description: Subscription inactive or not allowed
        "413":
          description: File too large
        "500":
          description: Internal server error

  /api/emr/procedures:
    get:
      summary: Get procedures configured for a practice (via API key)
      description: |
        Returns the list of unique procedures (e.g. ECG, BP, Spiro, TEMP)
        configured for the practice associated with the provided API key.

        **Authentication**:
        - HTTP header: `x-api-key: YOUR_API_KEY`

        The API key is used to look up the practice owner (admin = true) inside Nexumed;
        procedure names are returned from the practice’s shared device configuration.
      security:
        - ApiKeyAuth: []
      responses:
        "200":
          description: Successfully resolved procedures for this practice
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                    example: true
                  procedures:
                    type: array
                    items:
                      type: string
              example:
                ok: true
                procedures:
                  - TEMP
                  - Spiro
                  - SPO2
                  - ECG
        "400":
          description: Missing API key
        "401":
          description: Unauthorized (invalid or unknown API key)
        "500":
          description: Internal server error

  /emr/eid/{drsId}/patient-data-out:
    get:
      summary: eID reader — GET patient data XML
      description: |
        Returns the most recently staged eID patient XML for the given **drsId**.
        Supports conditional requests via **If-None-Match**.
        Returns **404** if no file is staged or it expired (5 min from time it has been pushed in the Nexumed App).
      parameters:
        - name: drsId
          in: path
          required: true
          description: Unique doctor/practice identifier used when staging the work order
          schema:
            type: string
        - name: If-None-Match
          in: header
          required: false
          description: ETag from a previous 200 response; if it matches, a **304 Not Modified** is returned
          schema:
            type: string
            example: "\"6f1d7a1b9e2d3c4f...\""
      responses:
        "200":
          description: XML found and returned
          headers:
            ETag:
              description: Strong ETag for the XML body (quoted)
              schema:
                type: string
                example: "\"6f1d7a1b9e2d3c4f...\""
            Last-Modified:
              description: When the payload was staged (HTTP-date)
              schema:
                type: string
                example: "Tue, 04 Nov 2025 12:34:56 GMT"
            X-Checksum-SHA256:
              description: SHA-256 checksum of the XML body (hex)
              schema:
                type: string
                example: "6f1d7a1b9e2d3c4f9a0b..."
            Cache-Control:
              description: No-store to prevent caching at rest
              schema:
                type: string
                example: "no-store"
            Content-Disposition:
              description: Suggested filename
              schema:
                type: string
                example: "attachment; filename=\"patient-data-out.xml\""
            Content-Length:
              description: Length of the XML body in bytes
              schema:
                type: string
                example: "12345"
          content:
            application/xml:
              schema:
                type: string
              example: |
                <?xml version="1.0" encoding="UTF-8"?>
                <eid version="4.5">
                  <identity nationalnumber="00000000000" dateofbirth="19700101" gender="male" specialstatus="NO_STATUS">
                    <name>DOE JOHN</name>
                    <firstname>JOHN</firstname>
                    <nationality>BE</nationality>
                    <placeofbirth>BRUSSELS</placeofbirth>
                    <photo></photo>
                  </identity>
                </eid>
        "304":
          description: Not Modified (content unchanged since the provided ETag)
        "404":
          description: No staged XML found for this drsId, or it has expired
          content:
            text/plain:
              schema:
                type: string
                example: Not found or expired
        "500":
          description: Internal server error

  /api/emr/results:
    get:
      summary: Fetch queued EMR results (via API key).
      description: |
        Returns **all queued results** currently staged for the practice’s configured EMR provider.

        **Authentication**:
        - HTTP header: `x-api-key: YOUR_API_KEY`

        This is intended for EMRs to request periodically (e.g. after each patient or end-of-day).
      security:
        - ApiKeyAuth: []
      responses:
        "200":
          description: Results returned successfully (queue was cleared after reading)
          content:
            application/json:
              schema:
                type: object
                required: [ok, provider, count, results]
                properties:
                  ok:
                    type: boolean
                    example: true
                  provider:
                    type: string
                    example: "EMR name"
                  count:
                    type: integer
                    example: 2
                  results:
                    type: array
                    description: |
                      Array of result objects (each item is a JSON object previously queued by Nexumed).
                      Contents can include XML/PDF payloads and metadata like procedure/device/model.
                    items:
                      type: object
                      additionalProperties: true
              example:
                ok: true
                provider: "EMR name"
                count: 2
                results:
                  - resultId: "43feba5-6c91-436a-9e9e-2771ecc2ebfd"
                    provider: "EMR name"
                    procedure: "ECG"
                    device: "SCHILLER"
                    model: "CARDIOVIT-AT-102-G2"
                    createdAt: "2025-12-24T10:56:11.982Z"
                    files:
                      - type: "KMEHR_XML"
                        fileName: "SMITH_kmehr_1766573771982.xml"
                        mimeType: "application/xml"
                        encoding: "utf8"
                        content: "<kmehrmessage xmlns=\"http://www.ehealth.fgov.be/standards/kmehr/schema/v1\">...</kmehrmessage>"
                      - type: "PDF"
                        fileName: "SMITH_ECG_1766573771960.pdf"
                        mimeType: "application/pdf"
                        encoding: "base64"
                        content: "JVBERi0xLjQKJ..."
                  - resultId: "3707f1ca-11da-4fe4-8756-d557d42405c2"
                    provider: "EMR name"
                    procedure: "ECG"
                    device: "SCHILLER"
                    model: "CARDIOVIT-AT-102-G2"
                    createdAt: "2025-12-24T10:56:36.299Z"
                    files:
                      - type: "KMEHR_XML"
                        fileName: "ANDERSON_kmehr_1766573796299.xml"
                        mimeType: "application/xml"
                        encoding: "utf8"
                        content: "<kmehrmessage ...>...</kmehrmessage>"
                      - type: "PDF"
                        fileName: "ANDERSON_ECG_1766573771960.pdf"
                        mimeType: "application/pdf"
                        encoding: "base64"
                        content: "JVBERi0xLjQKJ..."
        "204":
          description: No queued results available (empty queue)
        "400":
          description: Bad request (e.g. missing API key, or no EMR provider configured)
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Missing API key"
        "401":
          description: Unauthorized (invalid API key)
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Invalid API key"
        "403":
          description: Subscription inactive or not allowed
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Subscription inactive"
                  drsId:
                    type: string
                    example: "98765432112"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Failed to fetch EMR results"
